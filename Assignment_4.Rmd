---
title: "HW #4"
author: "Siavash Mortezavi, Jason Liu, Holly Capell, Sangyu Shen, Kunal Kotian"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document: 
    latex_engine: xelatex
---

---------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RPostgreSQL)
drv <- dbDriver("PostgreSQL")
first_database <- dbConnect(drv, dbname = "msan_691", host = "localhost", port = 5432, user = "postgres", password = "postgres")
```


# 4A: Aggregate Functions and Dates

## Q. (1)

(a)

```{r R.options = list(max.print = 10)}
 select count(1) from stocks2016.d2010;
```

(b)

```{r R.options = list(max.print = 10)}
select count(1) from (select distinct cusip 
  from stocks2016.d2010) as uniqcusips;
```

(c)

```{r R.options = list(max.print = 10)}
select count(1) from (select distinct cusip 
from stocks2016.d2011) as uniqcusips;
```

(d)

```{r R.options = list(max.print = 10)}
select cusip from
(select cusip, count(1) as ct 
  from stocks2016.d2010 group by cusip) as grouped
where ct < 50;
```

(e)

```{r R.options = list(max.print = 10)}
select count(1) from
(select cusip from
(select cusip, count(1) as ct 
  from stocks2016.d2010 group by cusip) as grouped
where ct < 50) as smallcusips;
```

(f)

```{r R.options = list(max.print = 10)}
select
sum(case when cusips_count < 50 then 1 else 0 end) as less_than_50,
sum(case when cusips_count > 100 then 1 else 0 end) as more_than_100
from (
select count(cusip) as cusips_count from stocks2016.d2010 
group by cusip) q1;
```

(g)

```{r R.options = list(max.print = 10)}
select numtype, count(1)
from
    (select case 
        when cusips_count < 50 then 'less than 50' 
        when cusips_count > 100 then 'greater than 100'
        end as numtype
    from (
    select count(cusip) as cusips_count 
    from stocks2016.d2010 
    group by cusip) q1) q2
where numtype is not null
group by numtype;
```


(h)

```{r R.options = list(max.print = 10)}
select numtype, avg(annual_vol) as avg_annual_vol
from
    (select annual_vol, case
        when days_count < 50 then 'less than 50'
        when days_count between 50 and 100 then 'between 50 and 100'
        when days_count > 100 then 'greater than 100'
        end as numtype
    from (
    select cusip, sum(vol) as annual_vol, count(retdate) as days_count
    from stocks2016.d2010
    group by cusip) as q1) as q2
where numtype is not null
group by numtype;
```

(i)

```{r R.options = list(max.print = 10)}
select numtype, avg(avg_vol) as avg_annual_vol
from
    (select avg_vol, case
        when days_count < 50 then 'less than 50'
        when days_count between 50 and 100 then 'between 50 and 100'
        when days_count > 100 then 'greater than 100'
        end as numtype
    from (
    select cusip, avg(vol) as avg_vol, count(retdate) as days_count
    from stocks2016.d2010
    group by cusip) as q1) as q2
where numtype is not null
group by numtype;
 
```

(j)

```{r R.options = list(max.print = 10)}
select count(*)
from (select distinct permno
    from (select permno from stocks2016.d2010
        where vol*prc > 100000000 )q1)q2;
   
```

(k)

```{r R.options = list(max.print = 10)}
select count(distinct permno)::float/(select count(distinct permno) 
from stocks2016.d2010) 
from stocks2016.d2010 where prc*vol > 100000000
   
```


## Q. (2)

```{r R.options = list(max.print = 100)}

```


\newpage

# 4B: Aggregation and Dates

## Q. (1)

```{r R.options = list(max.print = 100)}

```

## Q. (2)

```{r R.options = list(max.print = 100)}

```

\newpage

# 4C: Information Schema and Exploring the Relationship between Returns and Dollar Volume

## Q. (1)

(a)

```{r R.options = list(max.print = 100)}
qn_4c1a <- c("select count(1), data_type  from information_schema.columns
group by data_type;")
dbGetQuery(first_database,qn_4c1a)
```

(b)

```{r R.options = list(max.print = 100)}
qn_4c1b <- c("select  distinct(data_type)  from information_schema.columns;")
dbGetQuery(first_database,qn_4c1b)
```

(c)

```{r R.options = list(max.print = 100)}
qn_4c1c <- c("select count(1),data_type,table_schema from information_schema.columns
group by data_type,table_schema;")
dbGetQuery(first_database,qn_4c1c)
```

(d)

```{r R.options = list(max.print = 100)}


```
## Q. (2)

```{r R.options = list(max.print = 100)}

```


